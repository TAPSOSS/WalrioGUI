name: PR Checklist Validator

on:
  issue_comment:
    types: [created]

jobs:
  validate-pr:
    # Only run on PR comments that contain "bot, check"
    if: github.event.issue.pull_request && contains(github.event.comment.body, 'bot, check')
    runs-on: ubuntu-latest
    
    permissions:
      pull-requests: write
      issues: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequest } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            return pullRequest.body || '';
          result-encoding: string
      
      - name: Validate PR
        id: validate
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = ${{ steps.pr.outputs.result }};
            let errors = [];
            
            // Check for description
            const descriptionMatch = prBody.match(/## Description\s*([\s\S]*?)## Type of Change/);
            if (descriptionMatch) {
              const description = descriptionMatch[1];
              // Remove HTML comments and whitespace
              const cleanDescription = description.replace(/<!--[\s\S]*?-->/g, '').trim();
              if (cleanDescription.length === 0) {
                errors.push('❌ No description provided. Please add a description of your changes.');
              }
            } else {
              errors.push('❌ Could not find description section.');
            }
            
            // Check if all checkboxes are checked
            const uncheckedBoxes = prBody.match(/- \[ \]/g);
            if (uncheckedBoxes && uncheckedBoxes.length > 0) {
              errors.push(`❌ ${uncheckedBoxes.length} checkbox(es) are not checked. Please complete all checklist items.`);
            }
            
            // Check if there are any checkboxes at all
            const allBoxes = prBody.match(/- \[[xX ]\]/g);
            if (!allBoxes || allBoxes.length === 0) {
              errors.push('❌ No checkboxes found in PR description.');
            }
            
            return {
              valid: errors.length === 0,
              errors: errors
            };
      
      - name: Check for emojis in changed files
        id: emoji-check
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Read exceptions file
            let exceptions = [];
            const exceptionsPath = '.github/workflows/.doc_exceptions';
            if (fs.existsSync(exceptionsPath)) {
              const exceptionsContent = fs.readFileSync(exceptionsPath, 'utf8');
              exceptions = exceptionsContent
                .split('\n')
                .map(line => line.trim())
                .filter(line => line && !line.startsWith('#'));
            }
            
            // Function to check if file matches any exception pattern
            function isExcepted(filePath, patterns) {
              for (const pattern of patterns) {
                // Convert gitignore-style patterns to regex
                let regexPattern = pattern
                  .replace(/\./g, '\\.')
                  .replace(/\*/g, '.*')
                  .replace(/\?/g, '.');
                
                const regex = new RegExp('^' + regexPattern + '$');
                if (regex.test(filePath) || regex.test(path.basename(filePath))) {
                  return true;
                }
              }
              return false;
            }
            
            // Get changed files in the PR
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            // Emoji regex pattern (covers most common emojis)
            const emojiRegex = /[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F900}-\u{1F9FF}\u{1F018}-\u{1F270}\u{238C}-\u{2454}\u{20D0}-\u{20FF}\u{FE0F}]/gu;
            
            let emojiFindings = [];
            
            for (const file of files) {
              // Skip deleted files and excepted files
              if (file.status === 'removed' || isExcepted(file.filename, exceptions)) {
                continue;
              }
              
              try {
                // Get file content
                const { data: fileContent } = await github.rest.repos.getContent({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  path: file.filename,
                  ref: context.payload.issue.pull_request.head.sha
                });
                
                const content = Buffer.from(fileContent.content, 'base64').toString('utf8');
                const lines = content.split('\n');
                
                // Check each line for emojis
                lines.forEach((line, index) => {
                  const matches = line.match(emojiRegex);
                  if (matches) {
                    emojiFindings.push({
                      file: file.filename,
                      line: index + 1,
                      emojis: matches,
                      content: line.trim()
                    });
                  }
                });
              } catch (error) {
                // Skip files that can't be read (binary files, etc.)
                console.log(`Skipping file ${file.filename}: ${error.message}`);
              }
            }
            
            return {
              hasEmojis: emojiFindings.length > 0,
              findings: emojiFindings
            };
      
      - name: Post validation result
        uses: actions/github-script@v7
        with:
          script: |
            const validation = ${{ steps.validate.outputs.result }};
            const emojiCheck = ${{ steps.emoji-check.outputs.result }};
            
            let allErrors = [...validation.errors];
            
            // Add emoji findings to errors
            if (emojiCheck.hasEmojis) {
              allErrors.push('❌ **Emojis found in code files:**');
              
              // Group by file
              const fileGroups = {};
              emojiCheck.findings.forEach(finding => {
                if (!fileGroups[finding.file]) {
                  fileGroups[finding.file] = [];
                }
                fileGroups[finding.file].push(finding);
              });
              
              // Format error message
              for (const [file, findings] of Object.entries(fileGroups)) {
                allErrors.push(`\n**${file}:**`);
                findings.forEach(finding => {
                  const emojiList = [...new Set(finding.emojis)].join(' ');
                  allErrors.push(`  - Line ${finding.line}: Found ${emojiList}`);
                });
              }
            }
            
            let commentBody;
            if (allErrors.length === 0) {
              commentBody = '✅ **PR validation passed!**\n\nAll checkboxes are checked, a description has been provided, and no emojis were found in code files. This PR is ready for human review.';
            } else {
              commentBody = '⚠️ **PR validation failed**\n\nPlease address the following issues:\n\n' + 
                            allErrors.join('\n') + 
                            '\n\nOnce fixed, comment "bot, check" again to re-validate.';
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });
            
            // Fail the workflow if validation failed
            if (allErrors.length > 0) {
              core.setFailed('PR validation failed');
            }
